<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VTP Viewer</title>
  <script src="https://unpkg.com/vtk.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #404258;
    }
    #vtk-container {
      width: 100%;
      height: 100%;
    }
    #model-controls {
      position: absolute;
      top: 50px;
      left: 10px;
      background: rgba(255, 255, 255, 0.8);
      padding: 10px;
      z-index: 10;
    }
    #toggleViewMode {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 11;
    }
    .button-tooth {
      width: 50px;
      height: 50px;
      background: #ccc;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      font-size: 16px;
      color: black;
      cursor: pointer;
      transition: background 0.3s;
    }
    .button-tooth.active {
      background: #4a90e2;
      color: white;
    }
    .button-tooth:focus {
      outline: none;
    }
    #mandibleSelector {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }
    #opacityControl {
        display: flex;
        align-items: center;
        gap: 8px;
    }
      
  </style>
</head>

<body>

<button id="toggleViewMode">Switch to Orthographic</button>

<div id="model-controls">
  <button id="collapseBtn">Hide Panel</button><br><br>
  <button id="showAllBtn">Show All</button>
  <button id="hideAllBtn">Hide All</button>

  <div id="teethSelectorTop" style="
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 8px;
    margin-top: 10px;
    margin-bottom: 10px;">
  </div>

  <div id="teethSelectorBottom" style="
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 8px;
    margin-bottom: 10px;">
  </div>

  <div id="mandibleSelector" style="
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;">
    <button id="mandibleButton" class="button-tooth" style="width: 120px;">Mandible</button>
    <div id="opacityControl">
      <label for="opacitySlider">Opacity:</label>
      <input type="range" id="opacitySlider" min="10" max="100" value="100">
    </div>
  </div>
</div>

<div id="loadingScreen" style="
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  background: rgba(255,255,255,0.8);
  padding: 20px;
  border-radius: 10px;
  z-index: 100;">
  <div style="font-size: 24px; margin-bottom: 10px;">Loading models, please wait...</div>
  <div id="progressBarContainer" style="width: 300px; height: 20px; background: #eee; border-radius: 10px; overflow: hidden; margin: 0 auto;">
    <div id="progressBarFill" style="height: 100%; width: 0%; background: linear-gradient(90deg, #4caf50, #8bc34a); transition: width 0.3s;"></div>
  </div>
  <div id="progressText" style="margin-top: 10px;">0 / 17 loaded</div>
</div>

<div id="vtk-container"></div>

<script>
// VTK Setup
const fullScreenRenderer = vtk.Rendering.Misc.vtkFullScreenRenderWindow.newInstance({
    rootContainer: document.getElementById('vtk-container'),
    containerStyle: { height: '100%', width: '100%', position: 'absolute' },
});
const renderer = fullScreenRenderer.getRenderer();
const renderWindow = fullScreenRenderer.getRenderWindow();
const camera = renderer.getActiveCamera();

let isOrthographic = false;
document.getElementById('toggleViewMode').addEventListener('click', () => {
    isOrthographic = !isOrthographic;
    camera.setParallelProjection(isOrthographic);
    renderer.resetCameraClippingRange();
    renderWindow.render();
    document.getElementById('toggleViewMode').innerText = isOrthographic ? 'Switch to Perspective' : 'Switch to Orthographic';
});

// Model Files
const modelFiles = [
  "https://dl.dropboxusercontent.com/scl/fi/48kbvtoddojkrwesym611/Segment_1.vtp?rlkey=a0icyk6yqjt6ip5d7y5zorp9c&st=061jh94a&dl=0",
  "https://dl.dropboxusercontent.com/scl/fi/6x84ldggws22wfdtkuox5/Segment_2.vtp?rlkey=8ht91eflqqlakg4do2eremux3&st=u1llwdm9&dl=0",
  "https://dl.dropboxusercontent.com/scl/fi/whcbwbpspdkv5ql9akyyx/Segment_3.vtp?rlkey=353sw5qi8yukk2iz60t3f3bej&st=hs3yz19d&dl=0",
  "https://dl.dropboxusercontent.com/scl/fi/1ukn14i284v18tpn6thpz/Segment_4.vtp?rlkey=qcme6thjj7db9gcs7ipxqdwv0&st=bf0zhp7c&dl=0",
  "https://dl.dropboxusercontent.com/scl/fi/zjnvd86ca90r7vxuisjpn/Segment_5.vtp?rlkey=o43p11z23xro1u44jufo4pxbo&st=8vvlpa28&dl=0",
  "https://dl.dropboxusercontent.com/scl/fi/adpc1forsg9m0ddxrs853/Segment_6.vtp?rlkey=d5txn6qvva39joxpq3bxcrg1k&st=qwyxp1yj&dl=0",
  "https://dl.dropboxusercontent.com/scl/fi/rb5ns5g3fd83wsq10tlnz/Segment_7.vtp?rlkey=7dlszc71efxf646qxbv849sq4&st=vhw17trk&dl=0",
  "https://dl.dropboxusercontent.com/scl/fi/9uoz268nawtk7buj6py3h/Segment_8.vtp?rlkey=7fgb7oi3ms4zeayr398mw1cei&st=edogr7df&dl=0",
  "https://dl.dropboxusercontent.com/scl/fi/nc2nb2bxu3ibkixj8vpr1/Segment_9.vtp?rlkey=g4sc4iqc1xpliwpis13sfcbyd&st=wid7wcj1&dl=0",
  "https://dl.dropboxusercontent.com/scl/fi/oea7wq6ono6l51gbo5dq9/Segment_10.vtp?rlkey=5gao5nipgry7i69w1ykk2ztlf&st=sbaf0iw3&dl=0",
  "https://dl.dropboxusercontent.com/scl/fi/ko09cyjgiui31v0tnmp6a/Segment_11.vtp?rlkey=33gjhmcdhp3zmrrj0it8v926h&st=cwq2ekqb&dl=0",
  "https://dl.dropboxusercontent.com/scl/fi/yy7bqy8y3ikyo9hppmy6e/Segment_12.vtp?rlkey=g425li5d28sc25fupoetw05yg&st=38wqeppl&dl=0",
  "https://dl.dropboxusercontent.com/scl/fi/fq7oy5wf1eqj7bqmaomg7/Segment_13.vtp?rlkey=8m6zrcquo280sqnel726twspb&st=b8u92blq&dl=0",
  "https://dl.dropboxusercontent.com/scl/fi/3okub0k9vv8rsj7onn0um/Segment_14.vtp?rlkey=yro4ugi1prlwjadqa6zai2ebn&st=658wxwvh&dl=0",
  "https://dl.dropboxusercontent.com/scl/fi/w6sa1qe270gn312rf8cvm/Segment_15.vtp?rlkey=obzg2bo8x8zdkoe3mntim64zk&st=6xin07rp&dl=0",
  "https://dl.dropboxusercontent.com/scl/fi/o4aiy3f4dheac2e3mvemz/Segment_16.vtp?rlkey=ywipn3jw1ys70nkn4s33kzlwg&st=lzyjmjln&dl=0",
  "https://dl.dropboxusercontent.com/scl/fi/trfhf9b7pwbmrw6h5s3qz/Segment_17.vtp?rlkey=c0gpvagzgcx9xh9npq7atjyjw&st=jfnjkwgi&dl=0"
];

// Colors
const modelColors = [
  [128, 174, 128], [241, 214, 145], [177, 122, 101], [111, 184, 210],
  [216, 101, 79], [221, 130, 101], [144, 238, 144], [192, 104, 88],
  [220, 245, 20], [78, 63, 0], [255, 250, 220], [230, 220, 70],
  [200, 200, 235], [250, 250, 210], [244, 214, 49], [0, 151, 206],
  [216, 101, 79]
].map(c => c.map(v => v/255));

// Actors
const modelActors = new Array(18).fill(null).map(() => ({ actor: null }));

// UI
const selectorTop = document.getElementById('teethSelectorTop');
const selectorBottom = document.getElementById('teethSelectorBottom');
const mandibleButton = document.getElementById('mandibleButton');
const opacitySlider = document.getElementById('opacitySlider');
const collapseBtn = document.getElementById('collapseBtn')
let selectedActorIndex = null;

// Mandible Button
mandibleButton.addEventListener('click', () => {
  const actor = modelActors[0].actor;
  if (actor) {
    const visible = actor.getVisibility();
    actor.setVisibility(!visible);
    // Check if only one actor visible
    const visibleActors = modelActors.filter(m => m.actor && m.actor.getVisibility());
    if (!visible){
        // focusOnActor(actor, 50);
        renderer.resetCamera();
    }
    renderWindow.render();
    mandibleButton.classList.toggle('active', !visible);
    selectedActorIndex = 0;
    opacitySlider.disabled = !actor.getVisibility();
  }
});

// Create Teeth Buttons
function createToothButton(label, index, parent) {
  const button = document.createElement('button');
  button.className = 'button-tooth';
  button.innerText = label;
  button.dataset.index = index;
  parent.appendChild(button);

  button.addEventListener('click', () => {
    const actor = modelActors[index].actor;
    if (actor) {
      const visible = actor.getVisibility();
      actor.setVisibility(!visible);
      // Check if only one actor visible
        const visibleActors = modelActors.filter(m => m.actor && m.actor.getVisibility());
        if (visibleActors.length === 1) {
            focusOnActor(visibleActors[0].actor, 50);
        } else if (!visible){
            // renderer.resetCamera();
            focusOnActor(actor, 50);
        }
      renderWindow.render();
      button.classList.toggle('active', !visible);
      selectedActorIndex = null;
      // opacitySlider.disabled = true;
    }
  });
}

[
  ["48",16],["47",15],["46",14],["45",13],["44",12],["43",11],["42",10],["41",9]
].forEach(([label,index]) => createToothButton(label,index,selectorTop));
[
  ["31",1],["32",2],["33",3],["34",4],["35",5],["36",6],["37",7],["38",8]
].forEach(([label,index]) => createToothButton(label,index,selectorBottom));

// Load Models
loadedModels = 0;
Promise.all(modelFiles.map((file,index)=>{
  const reader = vtk.IO.XML.vtkXMLPolyDataReader.newInstance();
  const mapper = vtk.Rendering.Core.vtkMapper.newInstance();
  const actor = vtk.Rendering.Core.vtkActor.newInstance();
  actor.setMapper(mapper);
  actor.getProperty().setColor(...modelColors[index%modelColors.length]);

  return fetch(file).then(r=>r.arrayBuffer()).then(b=>{
    reader.parseAsArrayBuffer(b);
    mapper.setInputConnection(reader.getOutputPort());
    renderer.addActor(actor);
    modelActors[index].actor = actor;

    loadedModels++;
    document.getElementById('progressBarFill').style.width = `${(loadedModels)/modelFiles.length*100}%`;
    document.getElementById('progressText').innerText = `${loadedModels} / ${modelFiles.length} loaded`;
    renderWindow.render();
  });
})).then(()=>{
  modelActors.forEach(({actor})=>actor && actor.setVisibility(true));
  document.querySelectorAll('.button-tooth').forEach(b=>b.classList.add('active'));
  renderer.resetCamera();
  renderWindow.render();
  document.getElementById('loadingScreen').style.display = 'none';
});

// Opacity
// opacitySlider.disabled = true;
opacitySlider.addEventListener('input',()=>{
    // Works with only Mandible model, thus index 0
    modelActors[0].actor.getProperty().setOpacity(parseInt(opacitySlider.value)/100);
    renderWindow.render();
});

// Show/Hide All
document.getElementById('showAllBtn').addEventListener('click',()=>{
  modelActors.forEach(({actor})=>actor&&actor.setVisibility(true));
  document.querySelectorAll('.button-tooth').forEach(b=>b.classList.add('active'));
  renderWindow.render();
});
document.getElementById('hideAllBtn').addEventListener('click',()=>{
  modelActors.forEach(({actor})=>actor&&actor.setVisibility(false));
  document.querySelectorAll('.button-tooth').forEach(b=>b.classList.remove('active'));
  renderWindow.render();
});

// Collpase Button
collapseBtn.addEventListener('click', () => {
    const teethTop = document.getElementById('teethSelectorTop');
    const teethBottom = document.getElementById('teethSelectorBottom');
    const mandibleArea = document.getElementById('mandibleSelector');
    const opacityArea = document.getElementById('opacityControl');
  
    const currentlyVisible = teethTop.style.display !== 'none';
  
    teethTop.style.display = currentlyVisible ? 'none' : 'grid';
    teethBottom.style.display = currentlyVisible ? 'none' : 'grid';
    mandibleArea.style.display = currentlyVisible ? 'none' : 'flex'; // flex, not grid
    opacityArea.style.display = currentlyVisible ? 'none' : 'flex';   // flex, not grid
  
    collapseBtn.innerText = currentlyVisible ? 'Show Panel' : 'Hide Panel';
});

// Helper function to center the camera pivot to individual model's bounding box
function focusOnActor(actor, move_back) {
    const bounds = actor.getBounds(); // [xmin, xmax, ymin, ymax, zmin, zmax]
    // renderer.resetCamera(bounds);
    const center = [
        (bounds[0] + bounds[1]) / 2,
        (bounds[2] + bounds[3]) / 2,
        (bounds[4] + bounds[5]) / 2
    ];
    camera.setFocalPoint(...center);
    camera.setViewUp(0, 0, 1); // Keep standard "up" direction
    camera.setPosition(center[0], center[1] - move_back, center[2]); // Move back a bit
    renderer.resetCameraClippingRange();
    renderWindow.render();
}


</script>
</body>
</html>
